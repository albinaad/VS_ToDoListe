<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do Liste</title>
    <!-- Bootstrap Links zum einbinden-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</head>
<body>
    
  <div class="liste">
    <!-- Überschrift -->
    <h1>TO-DO LISTE</h1>
    <br>

    <!-- Button zum manuellen laden -->
    <button id="manuellesLaden" type="button" onclick="loadDoc()">Manual refresh</button>
    <br><br>

    <!-- To-Do-Liste wird hier angezeigt -->
    <div id="target">
    </div>
    <br><br>

    <!-- JavaScript Teil für die To-Do-Liste -->
    <script>

      // LoadDoc() Funktion lädt die Daten in die Tabelle
      function loadDoc() {
           var xhttp = new XMLHttpRequest();
           xhttp.onreadystatechange = function () {
               if (this.readyState == 4 && this.status == 200) {
            
               var row = JSON.parse(this.responseText);
               var txt = "<table class='table table-hover'>";
               txt += "<tr><td></td><td><input id='todo' type='text' name='todo' class='form-control' value='To-Do'></td><td><input id='datum' type='date' name='datum' class='form-control' value='Datum'></td><td></td><td> <button class='btn btn-default' onclick='addRow()'>Hinzufügen</button> </td></tr>"  
               txt += "<tr><th scope='col'>ID (id)</th><th scope='col'>To-Do (todo)</th><th scope='col'>Datum (datum)</th><th scope='col'>Action</th></tr>"
               for (var x in row) {
                 txt += "<tr><td>" + row[x].id + "</td><td>" + row[x].todo + "</td><td>" + row[x].datum + "</td><td> <button class='btn' onclick='deleteRow(" + row[x].id + ")'>DELETE</button> </td></tr>";
                }
               txt += "</table"

               document.getElementById("target").innerHTML = txt;
               }
            };
        xhttp.open("GET", "../database", true);
        xhttp.send();
      }
      
      // Löschfunktion
      function deleteRow(id) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        var answer = JSON.parse(this.responseText);
                        showSuccessAlert('Successfully deleted item:' + id + '; Message from server: ' + this.responseText);
                    } else if (this.readyState == 4 && this.status == 500) {
                        var error = JSON.parse(this.responseText);
                        console.log("ERROR: ", error);
                        showErrorAlert('ERROR on deleted item:' + id + '; Message from server: ' + this.responseText);
                    }
                    loadDoc();
                };
                xhttp.open("DELETE", "../database/" + id, true);
                xhttp.send();
            }
   
   // Hinzufügen-Funktion
   function addRow() {
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "../database", true);
      xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
      var data_to_send = {
      todo: "",
      datum: ""
      }
      data_to_send.todo = document.getElementById("todo").value;
      data_to_send.datum = document.getElementById("datum").value;
      xhr.send(JSON.stringify(data_to_send));

      xhr.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var answer = JSON.parse(this.responseText);
          showSuccessAlert('Successfully added item with todo:' + data_to_send.todo + '; datum: ' + data_to_send.datum + ' ; Message from server: ' + this.responseText);
        } else if (this.readyState == 4 && this.status == 500) {
          var error = JSON.parse(this.responseText);
          console.log("ERROR: ", error);
          showErrorAlert('ERROR on adding new item - message from server: ' + this.responseText);
        }
        // reload table
        loadDoc();
      };

     }

    // load the table at the start
    loadDoc();
   
   
   </script>

   

</body>
</html>